version: 2.1

jobs:
  test:
    parallelism: 3
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - run:
          name: verify position
          command: |
            printenv CIRCLE_NODE_INDEX
      - run:
          name: generate some files
          command: |
            mkdir generated
            curl -s https://ramenipsum.herokuapp.com/paragraphs/1 > "generated/.results_${CIRCLE_NODE_INDEX}"
      - persist_to_workspace:
          root: ~/project/generated
          paths:
            - .*
  collect:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - attach_workspace:
          at: ~/project/generated
      - run:
          name: concat files
          command: |
            cat generated/.results_* > combined.txt
      - run:
          name: examine combined file
          command: |
            cat combined.txt
            
            ls -laH .

workflows:
  combine-files:
    jobs:
      - test
      - collect:
          requires:
            - test
            
